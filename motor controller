#include <SoftwareSerial.h>
#include <Tic.h>
#include <LiquidCrystal.h>

// Rotary encoder pins
const int pinCLK = 2;  // Encoder A
const int pinDT  = 3;  // Encoder B
volatile int encoderPos = 0;  // Encoder position
volatile int lastEncoded = 0;

// SoftSerial: Arduino 10=RX, 11=TX
SoftwareSerial ticSerial(10, 11);  // Arduino 10=RX, 11=TX
TicSerial tic(ticSerial);          // Tic device

// LCD pins: RS=13, E=12, D4=7, D5=6, D6=5, D7=4
LiquidCrystal lcd(13, 12, 7, 6, 5, 4);

void setup() {
  // Initialize serial communication and LCD
  ticSerial.begin(9600);     
  lcd.begin(16, 2);

  // Encoder pins
  pinMode(pinCLK, INPUT_PULLUP);
  pinMode(pinDT, INPUT_PULLUP);

  // Capture encoder movement using interrupts
  attachInterrupt(digitalPinToInterrupt(pinCLK), updateEncoder, CHANGE);
  attachInterrupt(digitalPinToInterrupt(pinDT), updateEncoder, CHANGE);

  // Exit Tic safe start mode
  tic.exitSafeStart();
}

void updateEncoder() {
  int MSB = digitalRead(pinCLK);
  int LSB = digitalRead(pinDT);
  int encoded = (MSB << 1) | LSB;
  int sum = (lastEncoded << 2) | encoded;

  if (sum == 0b1101 || sum == 0b0100 || sum == 0b0010 || sum == 0b1011) encoderPos++;
  if (sum == 0b1110 || sum == 0b0111 || sum == 0b0001 || sum == 0b1000) encoderPos--;

  lastEncoded = encoded;

  // Limit position to -2000..+2000
  if (encoderPos > 2000) encoderPos = 2000;
  if (encoderPos < -2000) encoderPos = -2000;
}

void loop() {
  // Move motor to current position
  tic.setTargetPosition(encoderPos);

  // Display position on the right side of the LCD
  lcd.setCursor(10, 0);         // Row 1, right side
  lcd.print("Motor Pos: ");
  lcd.print("      ");           // Clear previous value
  lcd.setCursor(10, 0);
  lcd.print(encoderPos);         // Print new position
}
